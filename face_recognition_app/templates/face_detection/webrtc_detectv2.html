<!DOCTYPE html>
<html>
<head>
    <title>Face Detection with face-api.js</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #videoContainer { position: relative; margin: 20px 0; }
        #liveVideo { border: 1px solid #ccc; background: #000; }
        #canvas { position: absolute; top: 0; left: 0; }
        #results { margin-top: 20px; padding: 10px; border: 1px solid #ddd; min-height: 60px; }
        .match { color: green; font-weight: bold; }
        .no-match { color: red; }
        .scanning { color: blue; }
        button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        #loading { display: none; margin-top: 10px; }
        #faceInfo { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); padding: 5px; }
        #modelLoading { margin-top: 10px; color: blue; }
    </style>
</head>
<body>
    <h1>Face Detection with face-api.js</h1>
    <div id="modelLoading">Loading face detection library...</div>
    <div id="videoContainer">
        <video id="liveVideo" autoplay playsinline width="640" height="480"></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        <div id="faceInfo"></div>
    </div>
    <button id="startButton" disabled>Start Detection</button>
    <div id="loading">Processing face detection...</div>
    <div id="results">Status: Loading face detection library...</div>

    <!-- Load face-api.js from CDN with integrity check -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('liveVideo');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        const faceInfoDiv = document.getElementById('faceInfo');
        const modelLoadingDiv = document.getElementById('modelLoading');
        let stream = null;
        let processing = false;
        let detectionInterval = null;
        const checkInterval = 300; // Check every 300ms
        let modelsLoaded = false;

        // Configuration
        const detectionOptions = {
            withLandmarks: true,
            withDescriptors: false,
            minConfidence: 0.5
        };

        // First check if face-api.js loaded properly
        function checkFaceAPI() {
            if (typeof faceapi === 'undefined') {
                modelLoadingDiv.textContent = "Error: face-api.js failed to load. Please refresh the page.";
                return false;
            }
            return true;
        }

        // Load face-api.js models
        async function loadModels() {
            try {
                if (!checkFaceAPI()) return;

                modelLoadingDiv.textContent = "Loading face detection models...";

                // Load the models - using the correct paths
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Tiny.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');

                modelsLoaded = true;
                modelLoadingDiv.textContent = "Models loaded successfully!";
                startButton.disabled = false;
                resultsDiv.textContent = 'Status: Ready';
            } catch (err) {
                console.error('Error loading models:', err);
                modelLoadingDiv.textContent = "Error loading models: " + err.message;

                // Alternative model loading approach
                try {
                    modelLoadingDiv.textContent = "Trying alternative model loading...";
                    await faceapi.loadTinyFaceDetectorModel('https://justadudewhohacks.github.io/face-api.js/models');
                    await faceapi.loadFaceLandmarkTinyModel('https://justadudewhohacks.github.io/face-api.js/models');

                    modelsLoaded = true;
                    modelLoadingDiv.textContent = "Models loaded successfully (alternative method)!";
                    startButton.disabled = false;
                    resultsDiv.textContent = 'Status: Ready';
                } catch (err2) {
                    console.error('Alternative loading failed:', err2);
                    modelLoadingDiv.textContent = "Failed to load models. Please check your internet connection.";
                }
            }
        }

        // Start video stream
        startButton.addEventListener('click', async () => {
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });
                    video.srcObject = stream;
                    startButton.textContent = 'Stop Detection';
                    startDetection();
                } else {
                    stopDetection();
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    video.srcObject = null;
                    startButton.textContent = 'Start Detection';
                    resultsDiv.textContent = 'Status: Stopped';
                    faceInfoDiv.textContent = '';
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            } catch (err) {
                console.error('Error accessing camera:', err);
                resultsDiv.textContent = 'Error accessing camera: ' + err.message;
            }
        });

        function startDetection() {
            detectionInterval = setInterval(processFrame, checkInterval);
            resultsDiv.innerHTML = 'Status: <span class="scanning">Scanning for faces...</span>';
        }

        function stopDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
        }

        async function processFrame() {
            // Skip if already processing or no stream or models not loaded
            if (processing || !stream || !modelsLoaded) return;

            try {
                processing = true;

                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Clear previous drawings
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Detect faces using face-api.js
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions(detectionOptions))
                    .withFaceLandmarks(true);

                if (detections.length > 0) {
                    // Draw detections
                    faceapi.draw.drawDetections(canvas, detections);
                    faceapi.draw.drawFaceLandmarks(canvas, detections);

                    // Display face info
                    const mainFace = detections[0]; // Get the most prominent face
                    faceInfoDiv.textContent = `Face detected (${Math.round(mainFace.detection.score * 100)}% confidence)`;

                    // Only send to backend if we have a good face detection
                    if (mainFace.detection.score > 0.7) {
                        await verifyWithBackend();
                    }
                } else {
                    faceInfoDiv.textContent = 'No face detected';
                }
            } catch (err) {
                console.error('Frame processing error:', err);
                resultsDiv.textContent = 'Error during processing: ' + err.message;
            } finally {
                processing = false;
            }
        }

        async function verifyWithBackend() {
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = 'Status: <span class="scanning">Verifying face...</span>';

            try {
                // Convert canvas to base64
                const imageData = canvas.toDataURL('image/jpeg');

                // Send to server for face recognition
                const response = await fetch('/api/webrtc-match/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        image: imageData,
                        targetImage: 'elon.jpg' // Change to your target image
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.match) {
                    resultsDiv.innerHTML = `Status: <span class="match">Match found! (${Math.round(data.similarity)}% similarity)</span>`;
                } else {
                    resultsDiv.innerHTML = 'Status: <span class="no-match">No match found</span>';
                }
            } catch (err) {
                console.error('Verification error:', err);
                resultsDiv.textContent = 'Error during verification: ' + err.message;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize the application after the library loads
        function initializeApp() {
            if (checkFaceAPI()) {
                loadModels();
            } else {
                // Try again after a delay
                setTimeout(initializeApp, 500);
            }
        }

        // Start initialization when the page loads
        window.addEventListener('load', function() {
            // Wait a moment to ensure face-api.js is loaded
            setTimeout(initializeApp, 100);
        });
    </script>
</body>
</html>